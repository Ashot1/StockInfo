# Development Process (Cursor + Codex + Archon)

> Примечание: этот документ описывает **как мы пишем и вливаем код**. Управление задачами — в Archon MCP server и `Management-Process.md`.

---

## Цели процесса разработки
- Делать изменения маленькими, проверяемыми и легко ревьюимыми.
- Поддерживать автономность агентов: понятный DoD, тест-план, связка Task ↔ PR ↔ Archon Document.
- Уменьшать регрессии: минимум проверок в CI и обязательное ревью.

---

## Базовые правила

### 1) Один Task → один PR (по возможности)
- Каждая задача (Task в Archon) должна приводить к одному PR.
- Если задача разрослась — её нужно **декомпозировать** на 2–3 tasks, а не тащить огромный PR.

### 2) PR всегда связан с Task
В PR description обязательно:
- `Closes Task #<id>` (если PR полностью закрывает задачу)
- или `Refs Task #<id>` (если PR часть работы)

Это нужно для:
- прозрачного трекинга
- связи с документацией в Archon

### 3) Archon Document обновляется до и после PR
Минимум:
- до начала: скелет (Goal/DoD/тест-план) в Archon
- перед ревью: фактическая реализация/файлы/как проверить в Archon document

Использовать инструменты Archon MCP:
```bash
# Создание документации
manage_document("create", project_id="...", title="Issue #<n>: ...", document_type="spec", content={...})

# Обновление документации
manage_document("update", document_id="...", content={...})

# Получение документации
find_documents(project_id="...", query="Issue #<n>")
```

### 4) Reviewer — обязательная стадия
Никаких "просто смёрджил в main".
- Любой PR проходит ревью (человеком или Reviewer-агентом).

---

## Структура веток

### Ветка по задаче
Формат имени ветки:
- `issue-<id>-<slug>`

Примеры:
- `issue-123-auth-endpoint`
- `issue-58-portfolio-table`

### Commit-стиль (минимально)
Желательно (не обязательно):
- `feat: ...`
- `fix: ...`
- `chore: ...`
- `docs: ...`

Главное: коммиты должны помогать ревью, а не мешать.

---

## Шаблон PR (обязательные секции)

**Title:** кратко и по делу (обычно совпадает с Issue).

**Description:**
- Link: `Closes Task #<id>` (Archon)
- Summary: 3–8 буллетов "что сделано"
- How to test: шаги (или `make test`, `npm test`, и т.п.)
- Risks/Notes: что может сломаться или что не покрыто
- Screenshots/Logs: если UI/интеграции

**Checklist:**
- [ ] DoD выполнен
- [ ] Тест-план выполнен
- [ ] Archon document обновлён
- [ ] Нет лишних файлов/секретов/мусора

---

## Тестирование

### Минимальный набор (желательно всегда)
- линтер/форматтер (если есть)
- unit tests (если применимо)
- быстрый smoke test (ручной или автоматический)

### Тест-план обязан быть в двух местах
- в Task description (Archon) - кратко
- в Archon Document (подробно, с командами/шагами)

### Если тестов нет
В PR обязательно объяснить:
- почему
- как проверить вручную
- что будет добавлено позже (если будет)

---

## Definition of Done (DoD)
DoD должен быть:
- конкретным
- проверяемым
- измеряемым

Примеры хорошего DoD:
- “Добавлен endpoint `/api/login` + валидация + 401 на неверные креды + unit tests на 3 кейса”
- “UI-таблица рендерит 1000 строк без лагов, есть пустое состояние, сортировка по 2 колонкам, e2e smoke”

---

## Обновление статусов задач в Archon

Цель: статусы отражают реальность.

### Правило статусов
- Начал делать → **doing** (в Archon)
- Открыл PR → **review** (в Archon)
- Смёрджено → **done** (в Archon)

Использовать команды:
```bash
# Начало работы
manage_task("update", task_id="task-xxx", status="doing")

# Отправка на ревью
manage_task("update", task_id="task-xxx", status="review")

# После мерджа
manage_task("update", task_id="task-xxx", status="done")
```

---

## Процесс ревью (Reviewer-агент / человек)

### Что проверяем в первую очередь
1) Соответствие Goal/DoD
2) Корректность тест-плана и наличие тестов
3) Простота поддержки: читаемость, naming, структура
4) Edge-cases и ошибки
5) Побочные эффекты / регрессии

### Как писать замечания
- конкретно: что не так
- почему важно
- что нужно изменить
- если возможно — пример

### Итог ревью
- **Approve**: можно мерджить
- **Request changes**: вернуть задачу в In Progress

---

## Работа с Codex (как исполнителем задач)

### Рекомендуемый подход
- Codex запускается **на конкретный Task** (из Archon)
- Codex обязан:
  - прочитать Task + Archon Document
  - выполнить DoD
  - обновить Archon Document
  - открыть PR с правильной связкой `Closes Task #<id>`

### Получение задачи
```bash
# Получить список задач todo
tasks = find_tasks(filter_by="status", filter_value="todo")

# Получить документацию задачи
docs = find_documents(project_id=task.project_id, query=f"Issue #{task.id}")
```

### Деление на параллельные задачи
- Каждый Worker-агент / сессия Codex берёт **одну** задачу.
- Параллельные задачи должны быть независимыми (или чётко обозначить dependencies в Archon).

---

## Работа из Cursor

Cursor используется как:
- "командный пункт" (Planner и Reviewer-роль)
- место, где удобно координировать несколько задач
- интерфейс для работы с Archon MCP

Рекомендуется:
- использовать Archon MCP tools для управления задачами
- фиксировать решения в Archon documents, а не в чате
- держать открытым AGENTS.md для справки

---

## Частые проблемы и как их избегать

### PR слишком большой
- остановиться
- вытащить часть в отдельный Task (Archon)
- сделать 2 PR

### Агент "потерял контекст"
- вернуть его к Archon Document:
```bash
docs = find_documents(project_id="...", query="Issue #<n>")
```
- обновить Archon Document (архитектура/DoD)
- продолжить

### Ревью не может проверить
- добавь шаги запуска в Archon Document
- добавь тесты или чёткий manual тест-план
- сократи PR
